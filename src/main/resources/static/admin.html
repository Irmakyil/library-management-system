<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kütüphane Yönetim Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --accent-blue: #3b82f6;
            --accent-hover: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background-color: var(--bg-card);
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: #374151;
            color: white;
        }

        .nav-item.active {
            border-left: 3px solid var(--accent-blue);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0 5px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* TABLES & SEARCH */
        .search-bar {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            background-color: var(--bg-card);
            border: 1px solid #374151;
            border-radius: 8px;
            color: white;
            margin-bottom: 20px;
            font-family: inherit;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        th,
        td {
            text-align: left;
            padding: 16px;
            border-bottom: 1px solid #374151;
        }

        th {
            background-color: #2d3748;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        tr:hover {
            background-color: #2d3748;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            width: 500px;
            border: 1px solid #4b5563;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            background-color: #111827;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- LEFT MENU -->
    <div class="sidebar">
        <div class="sidebar-title">
            Kütüphane Portfolyo
        </div>
        <div class="nav-item active" onclick="showPage('dashboard')">Anasayfa</div>
        <div class="nav-item" onclick="showPage('members')">Üyeler</div>
        <div class="nav-item" onclick="showPage('books')">Kitaplar</div>
        <div class="nav-item" onclick="showPage('loans')">Ödünç İşlemleri</div>

        <div style="flex:1"></div>
        <button onclick="logout()" class="btn btn-danger" style="width:100%">Çıkış Yap</button>
    </div>

    <div class="main-content">

        <!-- DASHBOARD PAGE -->
        <div id="page-dashboard">
            <div class="page-header">
                <h1>Yönetici Paneli</h1>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Toplam Kitap</div>
                    <div class="stat-value" id="stat-total-books">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Toplam Üye</div>
                    <div class="stat-value" id="stat-total-members">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ödünç Verilen</div>
                    <div class="stat-value" id="stat-active-loans">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Geciken Kitaplar</div>
                    <div class="stat-value" id="stat-overdue-loans">-</div>
                </div>
            </div>
        </div>

        <!-- MEMBERS PAGE -->
        <div id="page-members" class="hidden">
            <div class="page-header">
                <h1>Üye Yönetimi</h1>
            </div>
            <input type="text" class="search-bar" placeholder="Üye Ara" onkeyup="searchMembers(this.value)">
            <table id="membersTable">
                <thead>
                    <tr>
                        <th>Ad Soyad</th>
                        <th>E-posta</th>
                        <th style="width: 100px;">İşlem</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- BOOKS PAGE -->
        <div id="page-books" class="hidden">
            <div class="page-header">
                <h1>Kitap Yönetimi</h1>
                <button class="btn btn-primary" onclick="openBookModal()">+ Yeni Kitap</button>
            </div>
            <input type="text" class="search-bar" placeholder="Kitap Ara" onkeyup="searchBooks(this.value)">
            <table id="booksTable">
                <thead>
                    <tr>
                        <th>Kitap Adı</th>
                        <th>Yazar</th>
                        <th>Yayın Yılı</th>
                        <th>Durum</th>
                        <th style="width: 150px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- LOANS PAGE -->
        <div id="page-loans" class="hidden">
            <div class="page-header">
                <h1>Ödünç İşlemleri</h1>
            </div>
            <input type="text" class="search-bar" placeholder="Ara (Üye veya Kitap...)"
                onkeyup="searchLoans(this.value)">
            <table id="loansTable">
                <thead>
                    <tr>
                        <th>Üye Adı</th>
                        <th>Kitap Adı</th>
                        <th>Alma Tarihi</th>
                        <th>Teslim Tarihi</th>
                        <th>Durum</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    <!-- MODALS -->
    <!-- USER DETAIL MODAL -->
    <div id="userDetailModal" class="modal hidden">
        <div class="modal-content" style="width: 600px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="detailName" style="margin:0;">Kullanıcı Detayı</h2>
                <div id="detailTotalPenalty" style="font-size:1.2rem; font-weight:bold; color:var(--danger)"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h4 style="color:var(--accent-blue); border-bottom:1px solid #374151; padding-bottom:5px;">
                        Okudukları</h4>
                    <div id="detailActiveLoans" style="max-height:200px; overflow-y:auto; font-size:0.9rem;"></div>
                </div>
                <div>
                    <h4 style="color:var(--success); border-bottom:1px solid #374151; padding-bottom:5px;">Geçmiş</h4>
                    <div id="detailHistoryLoans" style="max-height:200px; overflow-y:auto; font-size:0.9rem;"></div>
                </div>
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="document.getElementById('userDetailModal').classList.add('hidden')"
                    class="btn btn-primary">Kapat</button>
            </div>
        </div>
    </div>

    <!-- BOOK MODAL -->
    <div id="bookModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top:0;">Kitap Ekle</h2>
            <input type="hidden" id="bookId">

            <label>Kitap Adı</label>
            <input type="text" id="bookTitle">

            <label>Yazar</label>
            <input type="text" id="bookAuthorName">

            <label>ISBN</label>
            <input type="text" id="bookIsbn">

            <label>Yayın Yılı</label>
            <input type="number" id="bookYear">

            <label>Kategori</label>
            <select id="bookCategory"></select>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('bookModal').classList.add('hidden')"
                    class="btn btn-danger">İptal</button>
                <button onclick="saveBook()" class="btn btn-primary">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        const API = "http://localhost:8080/api";
        let allCategories = [];

        // --- NAVIGATION ---
        function showPage(pageId) {
            // Seçilen sayfayı (aktif sekmeyi) tarayıcıda saklar, sayfa yenilense bile aynı yerde kalır
            localStorage.setItem("activeTab", pageId);

            // Tüm sayfaları gizle
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            // Seçilen sayfayı göster
            const pageEl = document.getElementById(`page-${pageId}`);
            if (pageEl) pageEl.classList.remove('hidden');

            // Sol menüde aktif sayfayı vurgula
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Sol menüde aktif sayfayı bul
            const navLink = document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`);
            if (navLink) navLink.classList.add('active');

            // Sayfa verilerini yükle
            if (pageId === 'dashboard') loadDashboardStats();
            if (pageId === 'members') loadMembers();
            if (pageId === 'books') loadBooks();
            if (pageId === 'loans') loadLoans();
        }

        // --- AUTH ---
        window.onload = function () {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || user.role !== "ADMIN") {
                window.location.href = "index.html";
                return;
            }
            loadCategories();

            // Son aktif sayfayı geri yükle
            const lastTab = localStorage.getItem("activeTab") || "dashboard";
            showPage(lastTab);
        }

        function logout() {
            localStorage.removeItem("user");
            window.location.href = "index.html";
        }

        // --- DASHBOARD STATS ---
        async function loadDashboardStats() {
            const [books, members, loans] = await Promise.all([
                fetch(`${API}/books`).then(r => r.json()),
                fetch(`${API}/members`).then(r => r.json()),
                fetch(`${API}/loans`).then(r => r.json())
            ]);

            document.getElementById('stat-total-books').innerText = books.length;
            document.getElementById('stat-total-members').innerText = members.length; // Removing admin might be good but ok for now

            const activeLoans = loans.filter(l => l.returnDate === null);
            document.getElementById('stat-active-loans').innerText = activeLoans.length;

            const overdue = activeLoans.filter(l => {
                const dueDate = new Date(l.loanDate);
                dueDate.setDate(dueDate.getDate() + 15);
                return new Date() > dueDate;
            });
            document.getElementById('stat-overdue-loans').innerText = overdue.length;
        }

        // --- MEMBERS ---
        async function loadMembers(query = "") {
            const url = query ? `${API}/members/search?query=${query}` : `${API}/members`;
            const res = await fetch(url);
            const data = await res.json();
            renderMembers(data);
        }

        function searchMembers(val) {
            loadMembers(val);
        }

        function renderMembers(users) {
            const tbody = document.querySelector("#membersTable tbody");
            tbody.innerHTML = "";
            users.forEach(u => {
                tbody.innerHTML += `
                    <tr style="cursor:pointer" onclick="openUserDetail(${u.id}, '${u.firstName} ${u.lastName}')">
                        <td style="font-weight:500;">${u.firstName} ${u.lastName}</td>
                        <td style="color:var(--text-secondary);">${u.email}</td>
                        <td>
                            ${u.role !== 'ADMIN' ? `<button onclick="event.stopPropagation(); deleteUser(${u.id})" class="btn btn-sm btn-danger">Sil</button>` : '<span style="font-size:0.8rem; opacity:0.5">Admin</span>'}
                        </td>
                    </tr>
                `;
            });
        }

        async function openUserDetail(id, name) {
            document.getElementById('detailName').innerText = name;
            document.getElementById('userDetailModal').classList.remove('hidden');

            const activeDiv = document.getElementById("detailActiveLoans");
            const historyDiv = document.getElementById("detailHistoryLoans");
            activeDiv.innerHTML = "Yükleniyor...";
            historyDiv.innerHTML = "Yükleniyor...";

            const res = await fetch(`${API}/loans/member/${id}`);
            const loans = await res.json();

            activeDiv.innerHTML = "";
            historyDiv.innerHTML = "";
            let penalty = 0;

            if (loans.length === 0) {
                activeDiv.innerHTML = "Kayıt yok.";
                historyDiv.innerHTML = "Kayıt yok.";
            }

            loans.forEach(l => {
                const bookTitle = l.book ? l.book.title : "Silinmiş Kitap";
                if (l.penalty) penalty += l.penalty;

                if (l.returnDate === null) {
                    activeDiv.innerHTML += `<div style="padding:10px; background:#111827; margin-bottom:5px; border-radius:4px;">${bookTitle}</div>`;
                } else {
                    historyDiv.innerHTML += `<div style="padding:10px; background:#111827; margin-bottom:5px; border-radius:4px;">${bookTitle} <br><span style="font-size:0.8em; color:#6b7280">${l.returnDate}</span></div>`;
                }
            });
            document.getElementById('detailTotalPenalty').innerText = `${penalty} TL Ceza`;
        }

        async function deleteUser(id) {
            if (confirm("Emin misiniz?")) {
                await fetch(`${API}/members/${id}`, { method: "DELETE" });
                loadMembers();
                loadDashboardStats();
            }
        }

        // --- BOOKS ---
        async function loadBooks(query = "") {
            const url = query ? `${API}/books/search?query=${query}` : `${API}/books`;
            const res = await fetch(url);
            const data = await res.json();
            renderBooks(data);
        }

        function searchBooks(val) { loadBooks(val); }

        function renderBooks(books) {
            const tbody = document.querySelector("#booksTable tbody");
            tbody.innerHTML = "";
            books.forEach(b => {
                const status = b.available
                    ? `<span style="color:var(--success); background:rgba(16,185,129,0.1); padding:4px 8px; border-radius:4px; font-size:0.85rem;">Müsait</span>`
                    : `<span style="color:var(--danger); background:rgba(239,68,68,0.1); padding:4px 8px; border-radius:4px; font-size:0.85rem;">Ödünçte</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:500">${b.title}</td>
                        <td style="color:var(--text-secondary)">${b.author?.name || '-'}</td>
                        <td style="color:var(--text-secondary)">${b.publicationYear}</td>
                        <td>${status}</td>
                        <td>
                            <button onclick='editBook(${JSON.stringify(b)})' class="btn btn-sm btn-primary" style="margin-right:5px;">Düzenle</button>
                            <button onclick="deleteBook(${b.id})" class="btn btn-sm btn-danger">Sil</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function loadCategories() {
            const res = await fetch(`${API}/categories`);
            allCategories = await res.json();
            document.getElementById("bookCategory").innerHTML = allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
        }

        function openBookModal() {
            document.getElementById("modalTitle").innerText = "Yeni Kitap Ekle";
            document.getElementById("bookId").value = "";
            document.getElementById("bookTitle").value = "";
            document.getElementById("bookAuthorName").value = "";
            document.getElementById("bookIsbn").value = "";
            document.getElementById("bookYear").value = "";
            document.getElementById("bookModal").classList.remove("hidden");
        }

        function editBook(b) {
            document.getElementById("modalTitle").innerText = "Kitabı Düzenle";
            document.getElementById("bookId").value = b.id;
            document.getElementById("bookTitle").value = b.title;
            document.getElementById("bookAuthorName").value = b.author?.name || "";
            document.getElementById("bookIsbn").value = b.isbn;
            document.getElementById("bookYear").value = b.publicationYear;
            document.getElementById("bookCategory").value = b.category?.id;
            document.getElementById("bookModal").classList.remove("hidden");
        }

        async function saveBook() {
            const id = document.getElementById("bookId").value;
            const catVal = document.getElementById("bookCategory").value;
            const yearVal = document.getElementById("bookYear").value;

            const book = {
                title: document.getElementById("bookTitle").value,
                authorName: document.getElementById("bookAuthorName").value,
                isbn: document.getElementById("bookIsbn").value,
                publicationYear: yearVal ? parseInt(yearVal) : 0,
                categoryId: catVal ? catVal : null
            };

            const method = id ? "PUT" : "POST";
            const url = id ? `${API}/books/${id}` : `${API}/books`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(book)
                });

                if (!res.ok) {
                    const errMsg = await res.text();
                    throw new Error(errMsg || "Kaydetme başarısız");
                }

                document.getElementById("bookModal").classList.add("hidden");
                loadBooks();
                loadDashboardStats();
            } catch (err) {
                alert("Hata: " + err.message);
            }
        }

        async function deleteBook(id) {
            if (confirm("Silmek istediğinize emin misiniz?")) {
                await fetch(`${API}/books/${id}`, { method: "DELETE" });
                loadBooks();
                loadDashboardStats();
            }
        }

        // --- LOANS ---
        async function loadLoans(query = "") {
            const url = query ? `${API}/loans/search?query=${query}` : `${API}/loans`;
            const res = await fetch(url);
            const data = await res.json();
            renderLoans(data);
        }

        function searchLoans(val) { loadLoans(val); }

        function renderLoans(loans) {
            const tbody = document.querySelector("#loansTable tbody");
            tbody.innerHTML = "";
            loans.forEach(l => {
                const isReturn = l.returnDate !== null;
                let statusHtml = "";
                if (isReturn) {
                    statusHtml = `<span style="color:var(--success)">Teslim Edildi</span>`;
                } else {
                    const dueDate = new Date(l.loanDate);
                    dueDate.setDate(dueDate.getDate() + 1); // 15 gün olursa değiştirilmeli burası da şu an fonksiyonda 1 yaptığım için böyle !! (Sena)
                    const isOverdue = new Date() > dueDate;
                    statusHtml = isOverdue
                        ? `<span style="color:var(--danger); font-weight:bold">Gecikmiş!</span>`
                        : `<span style="color:var(--warning)">Okuyor</span>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${l.member ? l.member.firstName + ' ' + l.member.lastName : '-'}</td>
                        <td>${l.book ? l.book.title : '-'}</td>
                        <td>${l.loanDate}</td>
                        <td>${l.returnDate || '-'}</td>
                        <td>${statusHtml}</td>
                    </tr>
                `;
            });
        }

    </script>
</body>

</html>