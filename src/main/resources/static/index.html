<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Library Portfolio</title>
    <style>
        /* --- TEMEL AYARLAR & DARK MODE --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #111827;
            /* √áok koyu gri arka plan */
            color: #e5e7eb;
            /* A√ßƒ±k gri yazƒ± */
            margin: 0;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            margin-top: 0;
        }

        button {
            cursor: pointer;
            transition: 0.2s;
        }

        /* --- CONTAINER YAPISI --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        /* --- INPUT & FORM STƒ∞LLERƒ∞ --- */
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: #1f2937;
            border: 1px solid #374151;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* SELECT KUTUSU STƒ∞Lƒ∞ */
        select {
            width: 200px;
            /* Geni≈ülik ayarƒ± */
            padding: 12px;
            background-color: #1f2937;
            border: 1px solid #374151;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            color: white;
            width: 100%;
        }

        .btn-blue {
            background-color: #2563eb;
        }

        .btn-blue:hover {
            background-color: #1d4ed8;
        }

        .btn-green {
            background-color: #10b981;
        }

        .btn-green:hover {
            background-color: #059669;
        }

        .btn-red {
            background-color: #ef4444;
            width: auto;
            padding: 5px 10px;
            font-size: 11px;
        }

        .btn-red:hover {
            background-color: #dc2626;
        }

        /* --- LOGIN / REGISTER KARTLARI --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
            gap: 20px;
        }

        .card {
            background-color: #1f2937;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            width: 350px;
        }

        /* --- DASHBOARD GRID YAPISI (Bento Grid) --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- PROFƒ∞L KARTI --- */
        .profile-card {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #374151;
            height: fit-content;
        }

        .stat-box {
            background-color: #374151;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .fine-text {
            color: #f87171;
            font-size: 24px;
            font-family: monospace;
            font-weight: bold;
        }

        .loan-item {
            background: #111827;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
            border-left: 3px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Kƒ∞TAP Lƒ∞STESƒ∞ --- */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }

        .book-card {
            background-color: #1f2937;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #374151;
            position: relative;
        }

        .book-card h4 {
            margin-bottom: 5px;
            color: #fff;
        }

        .book-card p {
            font-size: 13px;
            color: #9ca3af;
            margin: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 10px;
        }

        .status-ok {
            background-color: #064e3b;
            color: #6ee7b7;
        }

        .status-out {
            background-color: #450a0a;
            color: #fca5a5;
        }

        .action-area {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>

    <div class="container">

        <div id="authSection" class="auth-container">
            <div class="card">
                <h2 style="text-align:center; color:#60a5fa;">Giri≈ü Yap</h2>
                <input type="text" id="loginEmail" placeholder="Email Adresi">
                <input type="password" id="loginPass" placeholder="≈ûifre">
                <button class="btn btn-blue" onclick="handleLogin()">Giri≈ü Yap</button>
            </div>

            <div class="card">
                <h2 style="text-align:center; color:#34d399;">Kayƒ±t Ol</h2>
                <input type="text" id="regName" placeholder="Ad">
                <input type="text" id="regSurname" placeholder="Soyad">
                <input type="text" id="regEmail" placeholder="Email">
                <input type="password" id="regPass" placeholder="≈ûifre">
                <button class="btn btn-green" onclick="handleRegister()">Kayƒ±t Ol</button>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1
                    style="background: linear-gradient(to right, #60a5fa, #34d399); -webkit-background-clip: text; color: transparent;">
                    üìö K√ºt√ºphane Portfolyo
                </h1>
                <button onclick="logout()"
                    style="background:none; border:1px solid #666; color:#ccc; padding:5px 15px; border-radius:4px;">√áƒ±kƒ±≈ü</button>
            </div>

            <div class="dashboard-grid">

                <div class="profile-card">
                    <h3 id="userNameDisplay">Kullanƒ±cƒ± Adƒ±</h3>
                    <p id="userEmailDisplay" style="color:#9ca3af; font-size:14px;">email@ornek.com</p>

                    <div class="stat-box">
                        <div style="font-size:12px; text-transform:uppercase; color:#9ca3af;">Toplam Ceza</div>
                        <div class="fine-text">0.00 TL</div>
                    </div>

                    <h4 style="border-bottom:1px solid #374151; padding-bottom:10px; margin-bottom:15px;">√ñd√ºn√ß
                        Aldƒ±klarƒ±m</h4>
                    <div id="myLoansList">
                        <p style="font-size:12px; color:#666;">Y√ºkleniyor...</p>
                    </div>

                    <div class="filter-card">
                        <h4 style="border-bottom:1px solid #374151; padding-bottom:10px; margin-bottom:15px;">Yazarlara
                            G√∂re Filtrele</h4>
                        <div id="authorsFilterList" style="max-height: 300px; overflow-y: auto;">
                            <p style="font-size:12px; color:#666;">Yazarlar y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="search-bar">
                        <select id="categorySelect" onchange="filterByCategory()">
                            <option value="all">T√ºm Kategoriler</option>
                        </select>

                        <input type="text" id="searchInput" placeholder="Kitap adƒ±, yazar veya ISBN ara..."
                            onkeyup="searchBooks()">
                    </div>

                    <div id="booksGrid" class="books-grid">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- KONFƒ∞G√úRASYON ---
        const API_BASE = "http://localhost:8080/api";
        let currentUser = null;
        let allBooks = [];

        // --- 1. AUTH ƒ∞≈ûLEMLERƒ∞ (Gƒ∞Rƒ∞≈û / KAYIT) ---

        async function handleRegister() {
            const member = {
                firstName: document.getElementById("regName").value,
                lastName: document.getElementById("regSurname").value,
                email: document.getElementById("regEmail").value,
                password: document.getElementById("regPass").value
            };

            try {
                const res = await fetch(`${API_BASE}/members/register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(member)
                });

                if (res.ok) {
                    alert("Kayƒ±t Ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapabilirsiniz.");
                    // Inputlarƒ± temizle
                    document.getElementById("regName").value = "";
                    document.getElementById("regSurname").value = "";
                    document.getElementById("regEmail").value = "";
                    document.getElementById("regPass").value = "";
                } else {
                    const errorMsg = await res.text();
                    alert("Kayƒ±t ba≈üarƒ±sƒ±z! Hata: " + (errorMsg || "Bilinmeyen hata"));
                }
            } catch (e) { console.error(e); alert("Sunucu ile baƒülantƒ± kurulamadƒ±."); }
        }

        async function handleLogin() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPass").value;

            try {
                const res = await fetch(`${API_BASE}/members/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });

                if (res.ok) {
                    currentUser = await res.json();

                    // Admin kontrol√º
                    if (currentUser.role === "ADMIN") {
                        localStorage.setItem("user", JSON.stringify(currentUser));
                        window.location.href = "admin.html";
                        return;
                    }

                    showDashboard();
                } else {
                    alert("Hatalƒ± email veya ≈üifre!");
                }
            } catch (e) { console.error(e); alert("Sunucu ile baƒülantƒ± kurulamadƒ±."); }
        }

        function logout() {
            currentUser = null;
            document.getElementById("dashboardSection").classList.add("hidden");
            document.getElementById("authSection").classList.remove("hidden");
        }

        // --- 2. DASHBOARD Y√ñNETƒ∞Mƒ∞ ---

        function showDashboard() {
            document.getElementById("authSection").classList.add("hidden");
            document.getElementById("dashboardSection").classList.remove("hidden");

            // ƒ∞sim Soyisim Doldur
            document.getElementById("userNameDisplay").innerText = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById("userEmailDisplay").innerText = currentUser.email;

            // Verileri √áek
            loadAllBooks();
            loadMyLoans();
            loadCategories();
            loadAuthors();
        }

        // --- 3. Kƒ∞TAP ƒ∞≈ûLEMLERƒ∞ (Lƒ∞STELEME & ARAMA) ---

        async function loadAllBooks() {
            try {
                const res = await fetch(`${API_BASE}/books`);
                allBooks = await res.json();
                renderBooks(allBooks);
            } catch (e) { console.error("Kitaplar y√ºklenemedi", e); }
        }

        function renderBooks(books) {
            const grid = document.getElementById("booksGrid");
            grid.innerHTML = "";

            if (books.length === 0) {
                grid.innerHTML = "<p style='color:#666;'>Kitap bulunamadƒ±.</p>";
                return;
            }

            books.forEach(book => {
                // Kitabƒ±n durumu backend'den 'available' (true/false) olarak geliyor
                const isAvailable = book.available;
                const statusClass = isAvailable ? "status-ok" : "status-out";
                const statusText = isAvailable ? "M√ºsait" : "√ñd√ºn√ßte";

                const btnStyle = !isAvailable
                    ? "width:auto; padding:5px 15px; font-size:12px; background-color:#4b5563; cursor:not-allowed;"
                    : "width:auto; padding:5px 15px; font-size:12px;";

                const card = `
                <div class="book-card">
                    <h4>${book.title}</h4>
                    <p>‚úçÔ∏è ${book.author.name}</p>
                    <p>üìÖ ${book.publicationYear}</p>
                    <div class="action-area">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <button 
                            onclick="borrowBook(${book.id})" 
                            class="btn btn-blue" 
                            style="${btnStyle}"
                            ${!isAvailable ? 'disabled' : ''}
                        >
                            √ñd√ºn√ß Al
                        </button>
                    </div>
                </div>
            `;
                grid.innerHTML += card;
            });
        }



        // --- Fƒ∞LTRELEME ƒ∞≈ûLEMLERƒ∞ ---

        let selectedCategoryId = 'all'; // Kategori durumunu globalde tutalƒ±m
        let selectedAuthorIds = []; // Se√ßili yazar ID'lerini burada tutacaƒüƒ±z

        // 1. Kategorileri Backend'den √áekip Dropdown'a Doldurur
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories`);
                const categories = await res.json();

                const selectBox = document.getElementById("categorySelect");
                // ƒ∞lk se√ßenek hari√ß temizle
                selectBox.innerHTML = '<option value="all">T√ºm Kategoriler</option>';

                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat.id;
                    option.text = cat.name;
                    selectBox.appendChild(option);
                });
            } catch (e) {
                console.error("Kategoriler y√ºklenemedi:", e);
            }
        }


        async function loadAuthors() {
            try {
                const res = await fetch(`${API_BASE}/authors`);
                const authors = await res.json();
                const listDiv = document.getElementById("authorsFilterList");
                listDiv.innerHTML = ""; // Temizle

                authors.forEach(auth => {
                    const authorName = `${auth.name}`;
                    const item = `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                        <input type="checkbox" value="${auth.id}" 
                            onchange="toggleAuthorFilter(this)" 
                            style="width: auto; margin-right: 10px; margin-bottom: 0;">
                        <label>${authorName}</label>
                    </div>
                `;
                    listDiv.innerHTML += item;
                });
            } catch (e) { console.error("Yazarlar y√ºklenemedi", e); }
        }

        // 1. Kategori deƒüi≈ütiƒüinde tetiklenir
        async function filterByCategory() {
            selectedCategoryId = document.getElementById("categorySelect").value;
            applyAllFilters(); // Merkezi filtreyi √ßaƒüƒ±r
        }

        // 2. Yazar checkbox'ƒ± deƒüi≈ütiƒüinde tetiklenir
        function toggleAuthorFilter(checkbox) {
            const id = parseInt(checkbox.value);
            if (checkbox.checked) {
                selectedAuthorIds.push(id);
            } else {
                selectedAuthorIds = selectedAuthorIds.filter(authorId => authorId !== id);
            }
            applyAllFilters(); // Merkezi filtreyi √ßaƒüƒ±r
        }

        // 3. MERKEZƒ∞ FONKSƒ∞YON: T√ºm filtreleri aynƒ± anda uygular
        // 3. MERKEZƒ∞ FONKSƒ∞YON: T√ºm filtreleri aynƒ± anda uygular
        function searchBooks() {
            applyAllFilters();
        }

        function applyAllFilters() {
            // Her zaman en g√ºncel tam listeden (allBooks) s√ºzmeye ba≈üla
            let filtered = allBooks;

            // KATEGORƒ∞ Fƒ∞LTRESƒ∞
            if (selectedCategoryId !== 'all') {
                // Kitabƒ±n kategorisi se√ßilen ID ile e≈üle≈ümeli
                filtered = filtered.filter(book => book.category && book.category.id == selectedCategoryId);
            }

            // YAZAR Fƒ∞LTRESƒ∞
            if (selectedAuthorIds.length > 0) {
                // Kitabƒ±n yazarƒ±, se√ßilen yazar listesinin i√ßinde olmalƒ±
                filtered = filtered.filter(book => book.author && selectedAuthorIds.includes(book.author.id));
            }

            // ARAMA Fƒ∞LTRESƒ∞ (Text Search)
            const query = document.getElementById("searchInput").value.toLowerCase();
            if (query) {
                filtered = filtered.filter(book =>
                    (book.title && book.title.toLowerCase().includes(query)) ||
                    (book.author && book.author.name.toLowerCase().includes(query)) ||
                    (book.isbn && book.isbn.includes(query))
                );
            }

            // Sonucu ekrana bas
            renderBooks(filtered);
        }

        // --- 4. √ñD√úN√á ALMA ƒ∞≈ûLEMƒ∞ ---

        async function borrowBook(bookId) {
            if (!currentUser) return;

            try {
                const res = await fetch(`${API_BASE}/loans/borrow`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        memberId: currentUser.id,
                        bookId: bookId
                    })
                });

                if (res.ok) {
                    alert("Kitap ba≈üarƒ±yla √∂d√ºn√ß alƒ±ndƒ±!");
                    loadAllBooks(); // Kitabƒ±n durumunu '√ñd√ºn√ßte' yapmak i√ßin
                    loadMyLoans();  // Sol listeye eklemek i√ßin
                } else {
                    const errorMsg = await res.text();
                    alert("HATA: " + errorMsg);
                }
            } catch (e) {
                console.error(e);
                alert("ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu.");
            }
        }

        // --- 5. √ñD√úN√á ALINANLARI Lƒ∞STELEME VE ƒ∞ADE ETME ---

        async function loadMyLoans() {
            if (!currentUser) return;

            try {
                // Backend'e eklediƒüimiz endpoint'i √ßaƒüƒ±rƒ±yoruz: /api/loans/member/{id}
                const res = await fetch(`${API_BASE}/loans/member/${currentUser.id}`);
                const loans = await res.json();

                const listDiv = document.getElementById("myLoansList");
                listDiv.innerHTML = "";

                if (loans.length === 0) {
                    listDiv.innerHTML = "<p style='font-size:12px; color:#666;'>Hen√ºz kitap almadƒ±nƒ±z.</p>";
                    // Ceza 0
                    document.querySelector(".fine-text").innerText = "0.00 TL";
                    return;
                }

                let totalPenalty = 0;

                loans.forEach(loan => {
                    // Eƒüer returnDate null ise kitap hala √ºyededir (Aktif)
                    const isActive = loan.returnDate === null;
                    const bookTitle = loan.book ? loan.book.title : "Bilinmeyen Kitap";

                    // Cezayƒ± topla
                    if (loan.penalty) totalPenalty += loan.penalty;

                    let actionHtml = "";
                    if (isActive) {
                        // ƒ∞ade Et butonu (Kƒ±rmƒ±zƒ±)
                        actionHtml = `
                        <button onclick="returnBook(${loan.id})" class="btn btn-red">
                            ƒ∞ade Et
                        </button>
                    `;
                    } else {
                        actionHtml = `<span style="color:#10b981; font-size:10px;">ƒ∞ade Edildi</span>`;
                    }

                    const item = `
                    <div class="loan-item">
                        <div>
                            <div style="font-weight:bold; color:#e5e7eb;">${bookTitle}</div>
                            <div style="font-size:11px; color:#9ca3af;">Tarih: ${loan.loanDate}</div>
                        </div>
                        ${actionHtml}
                    </div>
                `;
                    listDiv.innerHTML += item;
                });

                // Toplam cezayƒ± g√ºncelle
                document.querySelector(".fine-text").innerText = totalPenalty.toFixed(2) + " TL";

            } catch (e) {
                console.error("√ñd√ºn√ß listesi √ßekilemedi:", e);
            }
        }

        // Kitap ƒ∞ade Fonksiyonu
        async function returnBook(loanId) {
            if (!confirm("Bu kitabƒ± iade etmek istiyor musunuz?")) return;

            try {
                // Backend'e PUT isteƒüi at
                const res = await fetch(`${API_BASE}/loans/${loanId}/return`, {
                    method: "PUT"
                });

                if (res.ok) {
                    const updatedLoan = await res.json();

                    if (updatedLoan.penalty > 0) {
                        alert(`Kitap iade edildi. Gecikme Cezasƒ±: ${updatedLoan.penalty} TL`);
                    } else {
                        alert("Kitap zamanƒ±nda iade edildi. Te≈üekk√ºrler!");
                    }

                    loadMyLoans();  // Listeyi g√ºncelle (Buton kalksƒ±n)
                    loadAllBooks(); // Kitap artƒ±k "M√ºsait" olsun
                } else {
                    const err = await res.text();
                    alert("ƒ∞ade Hatasƒ±: " + err);
                }
            } catch (e) {
                console.error(e);
                alert("Sunucu hatasƒ±.");
            }
        }

    </script>

</body>

</html>