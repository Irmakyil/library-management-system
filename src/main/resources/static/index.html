<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Library Portfolio</title>
    <style>
        /* --- TEMEL AYARLAR & DARK MODE --- */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #111827; /* Ã‡ok koyu gri arka plan */
            color: #e5e7eb; /* AÃ§Ä±k gri yazÄ± */
            margin: 0; padding: 20px; 
        }
        
        h1, h2, h3 { margin-top: 0; }
        button { cursor: pointer; transition: 0.2s; }

        /* --- CONTAINER YAPISI --- */
        .container { max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* --- INPUT & FORM STÄ°LLERÄ° --- */
        input {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background-color: #1f2937; border: 1px solid #374151;
            color: white; border-radius: 6px; box-sizing: border-box;
        }
        input:focus { outline: none; border-color: #3b82f6; }

        /* SELECT KUTUSU STÄ°LÄ° */
        select {
            width: 200px; /* GeniÅŸlik ayarÄ± */
            padding: 12px;
            background-color: #1f2937;
            border: 1px solid #374151;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: #3b82f6; }

        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-weight: bold; color: white; width: 100%;
        }
        .btn-blue { background-color: #2563eb; }
        .btn-blue:hover { background-color: #1d4ed8; }
        .btn-green { background-color: #10b981; }
        .btn-green:hover { background-color: #059669; }
        .btn-red { background-color: #ef4444; width: auto; padding: 5px 10px; font-size: 11px;}
        .btn-red:hover { background-color: #dc2626; }

        /* --- LOGIN / REGISTER KARTLARI --- */
        .auth-container {
            display: flex; justify-content: center; align-items: center;
            height: 80vh; gap: 20px;
        }
        .card {
            background-color: #1f2937; padding: 30px;
            border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.3);
            border: 1px solid #374151; width: 350px;
        }

        /* --- DASHBOARD GRID YAPISI (Bento Grid) --- */
        .dashboard-grid {
            display: grid; grid-template-columns: 320px 1fr; gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* --- PROFÄ°L KARTI --- */
        .profile-card {
            background-color: #1f2937; padding: 20px; border-radius: 12px;
            border: 1px solid #374151; height: fit-content;
        }
        .stat-box {
            background-color: #374151; padding: 15px; border-radius: 8px;
            margin: 15px 0; text-align: center;
        }
        .fine-text { color: #f87171; font-size: 24px; font-family: monospace; font-weight: bold; }
        
        .loan-item {
            background: #111827; padding: 10px; margin-bottom: 8px;
            border-radius: 6px; font-size: 14px; 
            border-left: 3px solid #3b82f6;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- KÄ°TAP LÄ°STESÄ° --- */
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .books-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;
        }
        .book-card {
            background-color: #1f2937; padding: 15px; border-radius: 8px;
            border: 1px solid #374151; position: relative;
        }
        .book-card h4 { margin-bottom: 5px; color: #fff; }
        .book-card p { font-size: 13px; color: #9ca3af; margin: 0; }
        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 11px; margin-top: 10px;
        }
        .status-ok { background-color: #064e3b; color: #6ee7b7; }
        .status-out { background-color: #450a0a; color: #fca5a5; }
        
        .action-area { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="authSection" class="auth-container">
        <div class="card">
            <h2 style="text-align:center; color:#60a5fa;">GiriÅŸ Yap</h2>
            <input type="text" id="loginEmail" placeholder="Email Adresi">
            <input type="password" id="loginPass" placeholder="Åifre">
            <button class="btn btn-blue" onclick="handleLogin()">GiriÅŸ Yap</button>
        </div>
        
        <div class="card">
            <h2 style="text-align:center; color:#34d399;">KayÄ±t Ol</h2>
            <input type="text" id="regName" placeholder="Ad">
            <input type="text" id="regSurname" placeholder="Soyad">
            <input type="text" id="regEmail" placeholder="Email">
            <input type="password" id="regPass" placeholder="Åifre">
            <button class="btn btn-green" onclick="handleRegister()">KayÄ±t Ol</button>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="background: linear-gradient(to right, #60a5fa, #34d399); -webkit-background-clip: text; color: transparent;">
                ğŸ“š KÃ¼tÃ¼phane Portfolyo
            </h1>
            <button onclick="logout()" style="background:none; border:1px solid #666; color:#ccc; padding:5px 15px; border-radius:4px;">Ã‡Ä±kÄ±ÅŸ</button>
        </div>

        <div class="dashboard-grid">
            
            <div class="profile-card">
                <h3 id="userNameDisplay">KullanÄ±cÄ± AdÄ±</h3>
                <p id="userEmailDisplay" style="color:#9ca3af; font-size:14px;">email@ornek.com</p>
                
                <div class="stat-box">
                    <div style="font-size:12px; text-transform:uppercase; color:#9ca3af;">Toplam Ceza</div>
                    <div class="fine-text">0.00 TL</div>
                </div>

                <h4 style="border-bottom:1px solid #374151; padding-bottom:10px; margin-bottom:15px;">Ã–dÃ¼nÃ§ AldÄ±klarÄ±m</h4>
                <div id="myLoansList">
                    <p style="font-size:12px; color:#666;">YÃ¼kleniyor...</p>
                </div>
            </div>

            <div>
                <div class="search-bar">
                    <select id="categorySelect" onchange="filterByCategory()">
                        <option value="all">TÃ¼m Kategoriler</option>
                        </select>

                    <input type="text" id="searchInput" placeholder="Kitap adÄ±, yazar veya ISBN ara...">
                    <button class="btn btn-blue" style="width: auto;" onclick="searchBooks()">Ara</button>
                </div>

                <div id="booksGrid" class="books-grid">
                    </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- KONFÄ°GÃœRASYON ---
    const API_BASE = "http://localhost:8080/api";
    let currentUser = null;
    let allBooks = []; 

    // --- 1. AUTH Ä°ÅLEMLERÄ° (GÄ°RÄ°Å / KAYIT) ---

    async function handleRegister() {
        const member = {
            firstName: document.getElementById("regName").value, 
            lastName: document.getElementById("regSurname").value,
            email: document.getElementById("regEmail").value,
            password: document.getElementById("regPass").value
        };

        try {
            const res = await fetch(`${API_BASE}/members/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(member)
            });
            
            if(res.ok) {
                alert("KayÄ±t BaÅŸarÄ±lÄ±! Åimdi giriÅŸ yapabilirsiniz.");
                // InputlarÄ± temizle
                document.getElementById("regName").value = "";
                document.getElementById("regSurname").value = "";
                document.getElementById("regEmail").value = "";
                document.getElementById("regPass").value = "";
            } else {
                const errorMsg = await res.text();
                alert("KayÄ±t baÅŸarÄ±sÄ±z! Hata: " + (errorMsg || "Bilinmeyen hata"));
            }
        } catch (e) { console.error(e); alert("Sunucu ile baÄŸlantÄ± kurulamadÄ±."); }
    }

    async function handleLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPass").value;

        try {
            const res = await fetch(`${API_BASE}/members/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            if(res.ok) {
                currentUser = await res.json();
                showDashboard();
            } else {
                alert("HatalÄ± email veya ÅŸifre!");
            }
        } catch (e) { console.error(e); alert("Sunucu ile baÄŸlantÄ± kurulamadÄ±."); }
    }

    function logout() {
        currentUser = null;
        document.getElementById("dashboardSection").classList.add("hidden");
        document.getElementById("authSection").classList.remove("hidden");
    }

    // --- 2. DASHBOARD YÃ–NETÄ°MÄ° ---

    function showDashboard() {
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("dashboardSection").classList.remove("hidden");

        // Ä°sim Soyisim Doldur
        document.getElementById("userNameDisplay").innerText = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById("userEmailDisplay").innerText = currentUser.email;

        // Verileri Ã‡ek
        loadAllBooks(); 
        loadMyLoans(); 
        loadCategories();
    }

    // --- 3. KÄ°TAP Ä°ÅLEMLERÄ° (LÄ°STELEME & ARAMA) ---

    async function loadAllBooks() {
        try {
            const res = await fetch(`${API_BASE}/books`); 
            allBooks = await res.json();
            renderBooks(allBooks);
        } catch (e) { console.error("Kitaplar yÃ¼klenemedi", e); }
    }

    function renderBooks(books) {
        const grid = document.getElementById("booksGrid");
        grid.innerHTML = "";

        if(books.length === 0) {
            grid.innerHTML = "<p style='color:#666;'>Kitap bulunamadÄ±.</p>";
            return;
        }

        books.forEach(book => {
            // KitabÄ±n durumu backend'den 'available' (true/false) olarak geliyor
            const isAvailable = book.available; 
            const statusClass = isAvailable ? "status-ok" : "status-out";
            const statusText = isAvailable ? "MÃ¼sait" : "Ã–dÃ¼nÃ§te";

            const card = `
                <div class="book-card">
                    <h4>${book.title}</h4>
                    <p>âœï¸ ${book.author}</p>
                    <p>ğŸ“… ${book.publicationYear}</p>
                    <div class="action-area">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <button 
                            onclick="borrowBook(${book.id})" 
                            class="btn btn-blue" 
                            style="width:auto; padding:5px 15px; font-size:12px;"
                            ${!isAvailable ? 'disabled style="background-color:#4b5563; cursor:not-allowed;"' : ''}
                        >
                            Ã–dÃ¼nÃ§ Al
                        </button>
                    </div>
                </div>
            `;
            grid.innerHTML += card;
        });
    }

    function searchBooks() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        const filtered = allBooks.filter(book => 
            book.title.toLowerCase().includes(query) || 
            book.author.toLowerCase().includes(query) ||
            book.isbn.includes(query)
        );
        renderBooks(filtered);
    }

        // --- KATEGORÄ° FÄ°LTRELEME Ä°ÅLEMLERÄ° ---

    // 1. Kategorileri Backend'den Ã‡ekip Dropdown'a Doldurur
    async function loadCategories() {
        try {
            const res = await fetch(`${API_BASE}/categories`);
            const categories = await res.json();

            const selectBox = document.getElementById("categorySelect");
            // Ä°lk seÃ§enek hariÃ§ temizle
            selectBox.innerHTML = '<option value="all">TÃ¼m Kategoriler</option>';

            categories.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.text = cat.name;
                selectBox.appendChild(option);
            });
        } catch (e) {
            console.error("Kategoriler yÃ¼klenemedi:", e);
        }
    }

    // 2. SeÃ§im YapÄ±ldÄ±ÄŸÄ±nda KitaplarÄ± Filtreler
    async function filterByCategory() {
        const categoryId = document.getElementById("categorySelect").value;

        // EÄŸer "TÃ¼m Kategoriler" seÃ§ildiyse hepsini getir
        if (categoryId === 'all') {
            loadAllBooks();
            return;
        }

        // SeÃ§ili kategoriye gÃ¶re getir
        try {
            const res = await fetch(`${API_BASE}/books/category/${categoryId}`);
            const filteredBooks = await res.json();

            // Mevcut render fonksiyonunu kullanarak ekrana bas
            renderBooks(filteredBooks);

            // Global listeyi gÃ¼ncelle (arama yaparsa bu liste Ã¼zerinden yapsÄ±n diye)
            allBooks = filteredBooks; 
        } catch (e) {
            console.error("Filtreleme hatasÄ±:", e);
        }
    }

    // --- 4. Ã–DÃœNÃ‡ ALMA Ä°ÅLEMÄ° ---

    async function borrowBook(bookId) {
        if(!currentUser) return;
        
        try {
            const res = await fetch(`${API_BASE}/loans/borrow`, { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    memberId: currentUser.id, 
                    bookId: bookId 
                })
            });

            if(res.ok) {
                alert("Kitap baÅŸarÄ±yla Ã¶dÃ¼nÃ§ alÄ±ndÄ±! ğŸ‰");
                loadAllBooks(); // KitabÄ±n durumunu 'Ã–dÃ¼nÃ§te' yapmak iÃ§in
                loadMyLoans();  // Sol listeye eklemek iÃ§in
            } else {
                const errorMsg = await res.text();
                alert("HATA: " + errorMsg);
            }
        } catch (e) { 
            console.error(e); 
            alert("Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu."); 
        }
    }

    // --- 5. Ã–DÃœNÃ‡ ALINANLARI LÄ°STELEME VE Ä°ADE ETME ---

    async function loadMyLoans() {
        if (!currentUser) return;

        try {
            // Backend'e eklediÄŸimiz endpoint'i Ã§aÄŸÄ±rÄ±yoruz: /api/loans/member/{id}
            const res = await fetch(`${API_BASE}/loans/member/${currentUser.id}`);
            const loans = await res.json();
            
            const listDiv = document.getElementById("myLoansList");
            listDiv.innerHTML = "";
            
            if (loans.length === 0) {
                listDiv.innerHTML = "<p style='font-size:12px; color:#666;'>HenÃ¼z kitap almadÄ±nÄ±z.</p>";
                // Ceza 0
                document.querySelector(".fine-text").innerText = "0.00 TL";
                return;
            }

            let totalPenalty = 0;

            loans.forEach(loan => {
                // EÄŸer returnDate null ise kitap hala Ã¼yededir (Aktif)
                const isActive = loan.returnDate === null; 
                const bookTitle = loan.book ? loan.book.title : "Bilinmeyen Kitap";
                
                // CezayÄ± topla
                if(loan.penalty) totalPenalty += loan.penalty;

                let actionHtml = "";
                if (isActive) {
                    // Ä°ade Et butonu (KÄ±rmÄ±zÄ±)
                    actionHtml = `
                        <button onclick="returnBook(${loan.id})" class="btn btn-red">
                            Ä°ade Et
                        </button>
                    `;
                } else {
                    actionHtml = `<span style="color:#10b981; font-size:10px;">Ä°ade Edildi</span>`;
                }

                const item = `
                    <div class="loan-item">
                        <div>
                            <div style="font-weight:bold; color:#e5e7eb;">${bookTitle}</div>
                            <div style="font-size:11px; color:#9ca3af;">Tarih: ${loan.loanDate}</div>
                        </div>
                        ${actionHtml}
                    </div>
                `;
                listDiv.innerHTML += item;
            });

            // Toplam cezayÄ± gÃ¼ncelle
            document.querySelector(".fine-text").innerText = totalPenalty.toFixed(2) + " TL";

        } catch (e) {
            console.error("Ã–dÃ¼nÃ§ listesi Ã§ekilemedi:", e);
        }
    }

    // Kitap Ä°ade Fonksiyonu
    async function returnBook(loanId) {
        if(!confirm("Bu kitabÄ± iade etmek istiyor musunuz?")) return;

        try {
            // Backend'e PUT isteÄŸi at
            const res = await fetch(`${API_BASE}/loans/${loanId}/return`, {
                method: "PUT"
            });

            if (res.ok) {
                const updatedLoan = await res.json();
                
                if (updatedLoan.penalty > 0) {
                    alert(`Kitap iade edildi. Gecikme CezasÄ±: ${updatedLoan.penalty} TL`);
                } else {
                    alert("Kitap zamanÄ±nda iade edildi. TeÅŸekkÃ¼rler! âœ…");
                }

                loadMyLoans();  // Listeyi gÃ¼ncelle (Buton kalksÄ±n)
                loadAllBooks(); // Kitap artÄ±k "MÃ¼sait" olsun
            } else {
                const err = await res.text();
                alert("Ä°ade HatasÄ±: " + err);
            }
        } catch (e) {
            console.error(e);
            alert("Sunucu hatasÄ±.");
        }
    }

</script>

</body>
</html>